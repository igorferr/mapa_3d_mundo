<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Globo de Designers ‚Äî Three.js</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      overflow: hidden;
      background: #000;
      color: #fff;
    }
    #container {
      width: 100vw;
      height: 100vh;
    }
    #ui {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10;
      background: rgba(10, 14, 39, 0.9);
      padding: 20px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 400px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    input, select, button {
      padding: 10px 14px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #4D96FF;
      background: rgba(77, 150, 255, 0.1);
    }
    button {
      background: rgba(77, 150, 255, 0.2);
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: rgba(77, 150, 255, 0.4);
      transform: translateY(-1px);
    }
    #legend {
      font-size: 12px;
      line-height: 1.8;
    }
    #tooltip {
      position: fixed;
      background: rgba(10, 14, 39, 0.95);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      pointer-events: none;
      z-index: 100;
      font-size: 14px;
      line-height: 1.6;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      max-width: 300px;
      transition: all 0.2s;
    }
    #tooltip.locked {
      pointer-events: auto;
      border-color: #4D96FF;
      box-shadow: 0 4px 20px rgba(77, 150, 255, 0.3);
    }
    #tooltip.hidden {
      display: none;
    }
    #close-tooltip {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    #tooltip.locked #close-tooltip {
      display: flex;
    }
    #close-tooltip:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .tooltip-link {
      color: #4D96FF;
      text-decoration: none;
      font-weight: 600;
    }
    .tooltip-link:hover {
      text-decoration: underline;
    }
    option {
      background: #0a0e27;
      color: #fff;
    }
    #info {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(10, 14, 39, 0.8);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }
  </style>
</head>
<body>
  <div id="ui">
    <div class="controls">
      <input id="search" placeholder="Buscar por nome..." />
      <select id="select-area"><option value="">‚Äî Filtrar por √°rea ‚Äî</option></select>
      <select id="select-country"><option value="">‚Äî Filtrar por pa√≠s ‚Äî</option></select>
      <select id="select-year"><option value="">‚Äî Filtrar por ano ‚Äî</option></select>
      <button id="btn-reset">Reset</button>
    </div>
    <div id="legend"></div>
  </div>

  <div id="container"></div>
  <div id="tooltip" class="hidden"><button id="close-tooltip">√ó</button></div>
  <div id="info">üñ±Ô∏è Arraste para girar ‚Ä¢ Scroll para zoom ‚Ä¢ <strong>Clique nos pins</strong> para fixar</div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const container = document.getElementById("container");
    const tooltip = document.getElementById("tooltip");
    const searchInput = document.getElementById("search");
    const selectArea = document.getElementById("select-area");
    const selectCountry = document.getElementById("select-country");
    const selectYear = document.getElementById("select-year");
    const btnReset = document.getElementById("btn-reset");
    const legend = document.getElementById("legend");

    let scene, camera, renderer, controls;
    let globe, markers = [];
    let rawData = await fetch('./designers_enriched.json').then(r => r.json());
    let visibleIndices = [];
    let areaColors = {};
    const defaultColor = new THREE.Color(0x44aaff);
    const GLOBE_RADIUS = 5;
    let tooltipLocked = false;

    init();

    async function init(){
      await loadData();

      scene = new THREE.Scene();
      scene.fog = new THREE.Fog(0x000000, 50, 100);
      
      camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 18);

      renderer = new THREE.WebGLRenderer({antialias:true, alpha: true});
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 8;
      controls.maxDistance = 30;
      controls.autoRotate = true;
      controls.autoRotateSpeed = 0.5;

      // Luzes
      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);
      
      const directional = new THREE.DirectionalLight(0xffffff, 0.8);
      directional.position.set(5, 3, 5);
      scene.add(directional);

      createGlobe();
      createMarkers();

      window.addEventListener("resize", onResize);
      renderer.domElement.addEventListener("pointermove", onPointerMove);
      renderer.domElement.addEventListener("click", onPointerClick);
      document.getElementById("close-tooltip").addEventListener("click", unlockTooltip);
      searchInput.addEventListener("input", applyFiltersDebounced);
      selectArea.addEventListener("change", applyFilters);
      selectCountry.addEventListener("change", applyFilters);
      selectYear.addEventListener("change", applyFilters);
      btnReset.addEventListener("click", resetFilters);

      animate();
    }

    async function loadData(){
      try {
        const response = await fetch('./designers_enriched.json');
        const text = await response.text();
        const cleanText = text.replace(/:\s*NaN/g, ': null');
        rawData = JSON.parse(cleanText);
        
        // Filtra e normaliza dados
        rawData = rawData.filter(d => {
          const lat = d.lat || d.latitude || (d.coords && d.coords[0]);
          const lon = d.lon || d.longitude || (d.coords && d.coords[1]);
          return lat != null && lon != null && !isNaN(lat) && !isNaN(lon);
        }).map(d => {
          // Normaliza coordenadas
          if (d.coords && Array.isArray(d.coords)) {
            d.lat = Number(d.coords[0]);
            d.lon = Number(d.coords[1]);
          } else {
            d.lat = Number(d.lat || d.latitude);
            d.lon = Number(d.lon || d.longitude);
          }
          
          // Garante que ano seja n√∫mero
          if (d.ano) {
            d.ano = Number(d.ano);
          }
          
          return d;
        });
        
        console.log(`‚úÖ ${rawData.length} designers carregados!`);
        console.log('üìä Exemplo de dados:', rawData[0]); // Debug
        console.log('üåç Pa√≠ses encontrados:', [...new Set(rawData.map(d => d.pais).filter(Boolean))]);
        console.log('üìÖ Anos encontrados:', [...new Set(rawData.map(d => d.ano).filter(Boolean))]);
      } catch(e) {
        console.error("‚ùå Erro ao carregar:", e);
        rawData = [
          {nome: "Ana Silva", area: "UX Design", pais: "Brasil", ano: 2024, lat: -15.7801, lon: -47.9292},
          {nome: "Jo√£o Santos", area: "Branding", pais: "Brasil", ano: 2023, lat: -23.5505, lon: -46.6333},
          {nome: "Maria Costa", area: "UX Design", pais: "Portugal", ano: 2024, lat: 38.7223, lon: -9.1393}
        ];
      }

      buildFilterOptions();
    }

    function buildFilterOptions(){
      const areas = new Set();
      const countries = new Set();
      const years = new Set();
      
      rawData.forEach(d => {
        if (d.area) areas.add(d.area);
        if (d.pais) countries.add(d.pais);
        if (d.ano) years.add(d.ano);
      });

      const areaList = Array.from(areas).sort();
      const countryList = Array.from(countries).sort();
      const yearList = Array.from(years).sort((a, b) => b - a); // Ordem decrescente (mais recente primeiro)

      const palette = [0xFF6B6B,0x4D96FF,0x9B59B6,0xFFD66B,0x4EE39A,0xFF8C42,0xC0E0FF];
      areaList.forEach((a,i) => areaColors[a] = new THREE.Color(palette[i % palette.length]));

      // Popula select de √°reas
      areaList.forEach(a => {
        const o = document.createElement("option");
        o.value = a; o.textContent = a;
        selectArea.appendChild(o);
      });
      
      // Popula select de pa√≠ses
      countryList.forEach(c => {
        const o = document.createElement("option");
        o.value = c; o.textContent = c;
        selectCountry.appendChild(o);
      });
      
      // Popula select de anos
      yearList.forEach(y => {
        const o = document.createElement("option");
        o.value = y; o.textContent = y;
        selectYear.appendChild(o);
      });

      legend.innerHTML = areaList.map(a => `<div style="display:inline-block;margin-right:8px;margin-bottom:6px;"><span style="display:inline-block;width:12px;height:12px;background:${areaColors[a].getStyle()};border-radius:3px;margin-right:6px;vertical-align:middle;"></span>${a}</div>`).join("");
    }

    function createGlobe(){
      // Globo com textura da Terra
      const globeGeometry = new THREE.SphereGeometry(GLOBE_RADIUS, 64, 64);
      
      const textureLoader = new THREE.TextureLoader();
      const earthTexture = textureLoader.load(
        'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r158/examples/textures/planets/earth_atmos_2048.jpg',
        () => console.log('‚úÖ Textura da Terra carregada!')
      );
      
      const globeMaterial = new THREE.MeshPhongMaterial({
        map: earthTexture,
        shininess: 5,
        transparent: false
      });
      
      globe = new THREE.Mesh(globeGeometry, globeMaterial);
      scene.add(globe);

      // Atmosfera (glow)
      const atmosphereGeometry = new THREE.SphereGeometry(GLOBE_RADIUS * 1.02, 64, 64);
      const atmosphereMaterial = new THREE.MeshBasicMaterial({
        color: 0x4488ff,
        transparent: true,
        opacity: 0.15,
        side: THREE.BackSide
      });
      const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
      scene.add(atmosphere);

      // Estrelas ao fundo
      const starsGeometry = new THREE.BufferGeometry();
      const starsMaterial = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 0.7,
        transparent: true,
        opacity: 0.8
      });

      const starsVertices = [];
      for (let i = 0; i < 2000; i++) {
        const x = (Math.random() - 0.5) * 200;
        const y = (Math.random() - 0.5) * 200;
        const z = (Math.random() - 0.5) * 200;
        starsVertices.push(x, y, z);
      }

      starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
      const stars = new THREE.Points(starsGeometry, starsMaterial);
      scene.add(stars);
    }

    function latLonToVector3(lat, lon, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lon + 180) * (Math.PI / 180);

      const x = -(radius * Math.sin(phi) * Math.cos(theta));
      const z = radius * Math.sin(phi) * Math.sin(theta);
      const y = radius * Math.cos(phi);

      return new THREE.Vector3(x, y, z);
    }

    function createMarkers(){
      rawData.forEach((d, i) => {
        const position = latLonToVector3(d.lat, d.lon, GLOBE_RADIUS * 1.01);
        
        const markerGeometry = new THREE.SphereGeometry(0.06, 16, 16);
        const color = areaColors[d.area] || defaultColor;
        const markerMaterial = new THREE.MeshBasicMaterial({ 
          color: color,
          transparent: true,
          opacity: 0.9
        });
        const marker = new THREE.Mesh(markerGeometry, markerMaterial);
        marker.position.copy(position);
        marker.userData = { index: i, designer: d };
        
        const glowGeometry = new THREE.SphereGeometry(0.08, 16, 16);
        const glowMaterial = new THREE.MeshBasicMaterial({
          color: color,
          transparent: true,
          opacity: 0.3
        });
        const glow = new THREE.Mesh(glowGeometry, glowMaterial);
        glow.position.copy(position);
        
        scene.add(marker);
        scene.add(glow);
        markers.push({ marker, glow, data: d, index: i });
      });

      visibleIndices = Array.from({length: rawData.length}, (_,i)=>i);
    }

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();

    function onPointerMove(event){
      if (tooltipLocked) return;

      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = - ((event.clientY - rect.top) / rect.height) * 2 + 1;

      raycaster.setFromCamera(pointer, camera);
      const markerMeshes = markers.map(m => m.marker).filter(m => m.visible);
      const intersects = raycaster.intersectObjects(markerMeshes);

      if (intersects.length > 0){
        const item = intersects[0].object.userData.designer;
        showTooltip(item, event.clientX, event.clientY, false);
        controls.autoRotate = false;
        document.body.style.cursor = 'pointer';
      } else {
        hideTooltip();
        controls.autoRotate = true;
        document.body.style.cursor = 'default';
      }
    }

    function onPointerClick(event){
      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = - ((event.clientY - rect.top) / rect.height) * 2 + 1;

      raycaster.setFromCamera(pointer, camera);
      const markerMeshes = markers.map(m => m.marker).filter(m => m.visible);
      const intersects = raycaster.intersectObjects(markerMeshes);

      if (intersects.length > 0){
        const item = intersects[0].object.userData.designer;
        showTooltip(item, event.clientX, event.clientY, true);
        tooltipLocked = true;
        controls.autoRotate = false;
      } else if (!tooltip.contains(event.target)) {
        unlockTooltip();
      }
    }

    function showTooltip(item, clientX, clientY, locked){
      const name = item.nome || "‚Äî";
      const area = item.area || "‚Äî";
      const pais = item.pais || "‚Äî";
      const ano = item.ano || "‚Äî";
      const site = item.site || "";

      tooltip.classList.remove("hidden");
      if (locked) {
        tooltip.classList.add("locked");
      } else {
        tooltip.classList.remove("locked");
      }
      
      tooltip.style.left = `${clientX + 12}px`;
      tooltip.style.top = `${clientY + 12}px`;
      
      tooltip.innerHTML = `
        <button id="close-tooltip">√ó</button>
        <strong>${escapeHtml(name)}</strong><br/>
        <small>${escapeHtml(area)} ‚Ä¢ ${escapeHtml(pais)} ${ano !== "‚Äî" ? `‚Ä¢ ${ano}` : ''}</small>
        ${site ? `<div style="margin-top:8px;"><a class="tooltip-link" href="${escapeHtml(site)}" target="_blank" rel="noopener noreferrer">üîó Abrir site</a></div>` : ''}
        ${locked ? '<div style="margin-top:6px;font-size:11px;opacity:0.6;">Clique fora ou no X para fechar</div>' : ''}
      `;
      
      // Re-adiciona o event listener
      const closeBtn = document.getElementById("close-tooltip");
      if (closeBtn) {
        closeBtn.addEventListener("click", unlockTooltip);
      }
    }

    function unlockTooltip(){
      tooltipLocked = false;
      hideTooltip();
      controls.autoRotate = true;
    }

    function hideTooltip(){
      if (!tooltipLocked) {
        tooltip.classList.add("hidden");
        tooltip.classList.remove("locked");
      }
    }

    function escapeHtml(str){
      if (!str) return "";
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    let filterTimeout = null;
    function applyFiltersDebounced(){ 
      clearTimeout(filterTimeout); 
      filterTimeout = setTimeout(applyFilters, 180); 
    }

    function applyFilters(){
      const q = searchInput.value.trim().toLowerCase();
      const area = selectArea.value;
      const country = selectCountry.value;
      const year = selectYear.value;

      visibleIndices = [];
      markers.forEach(({marker, glow, data, index}) => {
        let ok = true;
        if (area && data.area !== area) ok = false;
        if (country && data.pais !== country) ok = false;
        if (year && String(data.ano) !== year) ok = false;
        if (q && !data.nome.toLowerCase().includes(q)) ok = false;
        
        if (ok) {
          visibleIndices.push(index);
          marker.visible = true;
          glow.visible = true;
        } else {
          marker.visible = false;
          glow.visible = false;
        }
      });
    }

    function resetFilters(){
      searchInput.value = "";
      selectArea.value = "";
      selectCountry.value = "";
      selectYear.value = "";
      markers.forEach(({marker, glow}) => {
        marker.visible = true;
        glow.visible = true;
      });
      visibleIndices = Array.from({length: rawData.length}, (_,i)=>i);
      unlockTooltip();
    }

    function onResize(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate(){
      requestAnimationFrame(animate);
      
      // Anima o glow dos marcadores
      markers.forEach(({glow}, i) => {
        if (glow.visible) {
          const scale = 1 + Math.sin(Date.now() * 0.002 + i) * 0.2;
          glow.scale.set(scale, scale, scale);
        }
      });
      
      controls.update();
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>